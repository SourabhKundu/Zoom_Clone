SELECT
    consl.consl_sk,
    CASE
        WHEN NVL(consl.consl_xref_id, 'E') = 'E' THEN consl.consl_desc
        ELSE consl.consl_xref_id || ' - ' || consl.consl_desc
    END AS decode,
    consl.cust_sk,
    consl.consl_upd_user_sk
FROM npf_consl consl
JOIN npf_consl_cmpnt cmpnt
    ON consl.consl_sk = cmpnt.consl_sk
WHERE consl.cust_sk = :p_cust_sk
  AND consl.consl_stat_dcde = 'ACTIVE'
  AND cmpnt.cmpnt_sk_val = COALESCE(
      (
        SELECT cmpnt_ac_sk
        FROM npf_decoder_xref
        WHERE decoder_ac_sk = :p_cmpnt_sk_val
          AND cust_sk = :p_cust_sk
        ORDER BY cmpnt_data_src_id ASC
        LIMIT 1
      ), :p_cmpnt_sk_val
  )
  AND cmpnt.cmpnt_dcde = :p_cmpnt_dcde
  AND cmpnt.consl_cmpnt_stat_dcde = 'ACTIVE'
ORDER BY decode;
