WITH split_codes AS (
  SELECT
    TRIM(value::string) AS cmnty_cde
  FROM TABLE(
    FLATTEN(
      INPUT => SPLIT(v_cmnty_code, ',')
    )
  )
)
SELECT
  SSP.SSP_ID,
  SSP.SSP_DESC,
  IFF(SSP.SSP_MSG_URL IS NULL,
      SSP.SSP_MSG_TEXT_CLOB,
      SSP.SSP_MSG_URL)            AS SSP_CONTENT,
  IFF(SSP.SSP_MSG_URL IS NULL, 'MSG', 'URL') AS SSP_TYPE,
  SSP.SSP_START_DATE,
  'public'                                  AS SSP_DISPLAY_TYPE
FROM WPA_SSP SSP
JOIN WPA_SSP_CMNTY SSP_CMNTY
  ON SSP.CMNTY_ID = SSP_CMNTY.CMNTY_ID
WHERE
  SSP_CMNTY.CMNTY_CDE IN (SELECT cmnty_cde FROM split_codes)
  AND CURRENT_DATE() 
      BETWEEN SSP.SSP_START_DATE 
          AND SSP.SSP_END_DATE
ORDER BY
  SSP.SSP_START_DATE DESC;
