WITH
  ac_det AS (
    SELECT
      acct.ac_sk,
      NVL(alias.ac_alias, NVL(alias.upd_ac_desc, acct.ac_desc)) AS sortcol,
      acct.data_src_id,
      COUNT(ndx.cmpnt_ac_sk) OVER (PARTITION BY ndx.decoder_ac_sk) AS enrl_ac_cnt,
      ndx.decoder_ac_sk,
      ndx.decoder_ac_id,
      NVL(acct.npf_data_load_date, ld.rpt_date) AS load_date
    FROM DEV_ANCHOR_ANALYTICS.WP_SRC.NPF_ACCOUNT           AS acct
    JOIN DEV_ANCHOR_ANALYTICS.WP_SRC.NPF_AC_CUST_USER      AS acuser
      ON acuser.ac_sk    = acct.ac_sk
     AND acuser.cust_sk  = (SELECT cust_sk FROM users)
     AND acuser.actv_flag= 'Y'
    LEFT JOIN DEV_ANCHOR_ANALYTICS.WP_SRC.NPF_DECODER_XREF  AS ndx
      ON ndx.cmpnt_ac_sk = acuser.ac_sk
     AND ndx.cust_sk     = acuser.cust_sk
    JOIN DEV_ANCHOR_ANALYTICS.WP_SRC.NPF_CUST_AC_ALIAS      AS alias
      ON alias.ac_sk    = acct.ac_sk
     AND alias.cust_sk  = acuser.cust_sk
    CROSS JOIN load_date AS ld
  ),

  tot_decoder_ac AS (
    SELECT
      decoder_ac_sk,
      COUNT(decoder_ac_sk) OVER (PARTITION BY decoder_ac_sk) AS tot_dec_ac
    FROM DEV_ANCHOR_ANALYTICS.WP_SRC.NPF_DECODER_XREF
    WHERE cust_sk = (SELECT cust_sk FROM users)
  ),

  accounts AS (
    SELECT DISTINCT
      CASE
        -- use the ac_det alias (ad.) here
        WHEN ad.enrl_ac_cnt > 0
             AND td.tot_dec_ac - ad.enrl_ac_cnt = 0
        THEN ad.decoder_ac_sk
        ELSE ad.ac_sk
      END                                                 AS ac_sk,

      'ACCOUNT' ||
      CASE
        WHEN ad.enrl_ac_cnt > 0
             AND td.tot_dec_ac - ad.enrl_ac_cnt = 0
        THEN ad.decoder_ac_sk
        ELSE ad.ac_sk
      END                                                 AS code,

      ad.sortcol                                          AS decode,
      2                                                    AS sortset,
      ad.sortcol                                          AS sortcol,
      'N'                                                  AS user_dflt_consl_flag,
      'ACC'                                                AS account_type,

      (SELECT sponsor_id FROM users)                      AS sponsor_id,

      CASE
        WHEN ad.enrl_ac_cnt > 0
             AND td.tot_dec_ac - ad.enrl_ac_cnt = 0
        THEN ad.decoder_ac_id
        ELSE (
          SELECT ac_id
          FROM DEV_ANCHOR_ANALYTICS.WP_SRC.NPF_ACCOUNT
          WHERE ac_sk = ad.ac_sk
        )
      END                                                 AS obj_id,

      ld.rpt_date                                         AS rpt_date

    FROM ac_det AS ad
    LEFT JOIN tot_decoder_ac AS td
      ON td.decoder_ac_sk = ad.decoder_ac_sk
    CROSS JOIN load_date AS ld

    WHERE
      CASE
        WHEN ad.enrl_ac_cnt > 0
             AND td.tot_dec_ac - ad.enrl_ac_cnt = 0
             AND ( (td.tot_dec_ac = 2 AND ad.data_src_id = 1) OR td.tot_dec_ac = 1 )
        THEN 'Y'
        WHEN ad.enrl_ac_cnt > 0
             AND td.tot_dec_ac - ad.enrl_ac_cnt = 0
             AND td.tot_dec_ac = 2
             AND ad.data_src_id = 2
        THEN 'N'
        ELSE 'Y'
      END = 'Y'
  )

SELECT * FROM consl_real
UNION ALL
SELECT * FROM consl_generic
UNION ALL
SELECT
  ac_sk, code, decode, sortset, sortcol,
  user_dflt_consl_flag, account_type,
  sponsor_id, obj_id, rpt_date
FROM accounts
ORDER BY sortset, user_dflt_consl_flag DESC, sortcol;
